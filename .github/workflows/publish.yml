name: Build and Publish Docker Image

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'WebSSH2 version (e.g., 2.4.0)'
        required: true
      publish:
        description: 'Push to GHCR'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release context
        id: context
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name || '' }}
          INPUT_VERSION: ${{ inputs.version || '' }}
          INPUT_PUBLISH: ${{ inputs.publish || 'false' }}
        run: |
          if [[ "${EVENT_NAME}" == "release" ]]; then
            RAW_VERSION="${RELEASE_TAG#v}"
            PUBLISH="true"
          else
            RAW_VERSION="${INPUT_VERSION#v}"
            PUBLISH="${INPUT_PUBLISH}"
          fi

          if [[ -z "${RAW_VERSION}" ]]; then
            echo "Version is required" >&2
            exit 1
          fi

          if [[ "${RAW_VERSION}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-(.+))?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE="${BASH_REMATCH[5]}"
          else
            echo "Version ${RAW_VERSION} is not valid semver" >&2
            exit 1
          fi

          IS_PRERELEASE="false"
          if [[ -n "${PRERELEASE}" ]]; then
            IS_PRERELEASE="true"
          fi

          echo "version=${RAW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
          echo "minor=${MINOR}" >> "$GITHUB_OUTPUT"
          echo "patch=${PATCH}" >> "$GITHUB_OUTPUT"
          echo "prerelease=${PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=${IS_PRERELEASE}" >> "$GITHUB_OUTPUT"
          echo "publish=${PUBLISH}" >> "$GITHUB_OUTPUT"

      - name: Fetch WebSSH2 artifact
        run: ./scripts/fetch-webssh2-release.sh "${{ steps.context.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        if: steps.context.outputs.publish == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ steps.context.outputs.is_prerelease == 'false' }}
            type=raw,value=v${{ steps.context.outputs.version }}
            type=raw,value=${{ steps.context.outputs.version }}
            type=raw,value=${{ steps.context.outputs.major }}.${{ steps.context.outputs.minor }},enable=${{ steps.context.outputs.is_prerelease == 'false' }}
            type=raw,value=${{ steps.context.outputs.major }},enable=${{ steps.context.outputs.is_prerelease == 'false' }}
          labels: |
            org.opencontainers.image.title=NGINX WebSSH2
            org.opencontainers.image.description=Production-ready NGINX + WebSSH2 container with FIPS 140-2 support
            org.opencontainers.image.vendor=f5govsolutions
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.documentation=${{ github.server_url }}/${{ github.repository }}/blob/main/README.md
            org.opencontainers.image.licenses=MIT
            webssh2.version=${{ steps.context.outputs.version }}

      - name: Build and (optionally) push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ steps.context.outputs.publish == 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            BUILD_VERSION=${{ steps.context.outputs.version }}
            WEBSSH2_VERSION=${{ steps.context.outputs.version }}
            VCS_REF=${{ github.sha }}

      - name: Update release notes with Docker images
        if: github.event_name == 'release' && steps.context.outputs.publish == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: v${{ steps.context.outputs.version }}
          SEMVER_FULL: ${{ steps.context.outputs.version }}
          SEMVER_MINOR: ${{ steps.context.outputs.major }}.${{ steps.context.outputs.minor }}
          SEMVER_MAJOR: ${{ steps.context.outputs.major }}
          IMAGE_DIGEST: ${{ steps.build.outputs.digest }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Compute lowercase repository name for GHCR
          REPO_LOWER=$(echo "${REPO_NAME}" | tr '[:upper:]' '[:lower:]')

          # Get current release body
          CURRENT_BODY=$(gh release view "$RELEASE_TAG" --json body --jq '.body')

          # Create Docker images section
          DOCKER_SECTION="

          ## ðŸ³ Docker Images

          This release is available as multi-platform images (linux/amd64, linux/arm64):

          ### GitHub Container Registry
          \`\`\`bash
          docker pull ghcr.io/${REPO_LOWER}:latest
          docker pull ghcr.io/${REPO_LOWER}:${SEMVER_FULL}
          docker pull ghcr.io/${REPO_LOWER}:${SEMVER_MINOR}
          docker pull ghcr.io/${REPO_LOWER}:${SEMVER_MAJOR}
          \`\`\`

          **Image Digest:** \`${IMAGE_DIGEST}\`

          **Links:**
          - [GitHub Container Registry](https://github.com/${REPO_LOWER}/pkgs/container/nginx-webssh2)
          "

          # Append Docker section to release notes
          gh release edit "$RELEASE_TAG" --notes "${CURRENT_BODY}${DOCKER_SECTION}"

      - name: Summarize build outcome
        run: |
          {
            echo "## Image Build"
            echo "WebSSH2 version: ${{ steps.context.outputs.version }}"
            echo "Pushed: ${{ steps.context.outputs.publish }}"
            if [[ "${{ steps.context.outputs.publish }}" == "true" ]]; then
              echo ""
              echo "### Tags"
              echo '```'
              echo "${{ steps.meta.outputs.tags }}"
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"
