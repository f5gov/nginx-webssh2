name: Sync WebSSH2 Release

on:
  repository_dispatch:
    types:
      - webssh2-release

jobs:
  release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanitize version
        id: version
        env:
          RAW_VERSION: ${{ github.event.client_payload.version }}
        run: |
          VERSION="${RAW_VERSION}"
          VERSION="${VERSION#webssh2-server-}"
          VERSION="${VERSION#v}"

          if [[ -z "${VERSION}" ]]; then
            echo "Unable to determine version from payload '${RAW_VERSION}'" >&2
            exit 1
          fi

          if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Version ${VERSION} is not valid semver" >&2
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Upstream release tag: ${RAW_VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "Container release version: ${VERSION}" >> "$GITHUB_STEP_SUMMARY"

      - name: Create release PR via release-please
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          REPO: ${{ github.repository }}
        run: |
          npx --yes release-please@latest manifest-pr \
            --config-file release-please-config.json \
            --manifest-file release-please-manifest.json \
            --repo-url "${REPO}" \
            --target-branch "main" \
            --release-as "${VERSION}"
