# Docker Compose for NGINX + WebSSH2 with FIPS Support
# Development and testing configuration

services:
  nginx-webssh2:
    build:
      context: .  # Build context expects vendor/webssh2 populated from release artifact
      dockerfile: Dockerfile
    image: nginx-webssh2:latest
    container_name: nginx-webssh2
    
    # Ports
    ports:
      - "8443:443"     # HTTPS only - host:container
    
    # Environment variables - customize as needed
    environment:
      # TLS Configuration
      TLS_MODE: self-signed
      TLS_PROTOCOLS: "TLSv1.2 TLSv1.3"
      TLS_CIPHERS: "ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-GCM-SHA256"
      TLS_CERT_CN: webssh2.localhost
      TLS_CERT_SAN: "webssh2.localhost,localhost,127.0.0.1"
      
      # mTLS Configuration (disabled by default)
      MTLS_ENABLED: "false"
      # MTLS_CA_CERT: /etc/nginx/certs/ca.pem
      # MTLS_VERIFY_DEPTH: 2
      # MTLS_OPTIONAL: "false"
      
      # FIPS Configuration
      FIPS_MODE: enabled
      FIPS_CHECK: "false"  # Set to false for development
      
      # NGINX Configuration
      NGINX_LISTEN_PORT: 443
      NGINX_SERVER_NAME: webssh2.localhost
      NGINX_WORKER_PROCESSES: 1
      NGINX_WORKER_CONNECTIONS: 1024
      NGINX_RATE_LIMIT: "10r/s"
      NGINX_RATE_LIMIT_BURST: 20
      NGINX_CONN_LIMIT: 100
      NGINX_ACCESS_LOG: "off"
      NGINX_ERROR_LOG_LEVEL: warn
      
      # Security Headers
      SECURITY_HEADERS: "true"
      HSTS_MAX_AGE: 31536000
      CSP_POLICY: "default-src 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; connect-src 'self' ws: wss:; font-src 'self'; img-src 'self' data:;"
      
      # WebSSH2 Core Configuration
      WEBSSH2_LISTEN_IP: 127.0.0.1
      WEBSSH2_LISTEN_PORT: 2222
      
      # WebSSH2 SSH Configuration
      WEBSSH2_SSH_HOST: ""  # Leave empty for dynamic host selection
      WEBSSH2_SSH_PORT: 22
      WEBSSH2_SSH_LOCAL_ADDRESS: ""
      WEBSSH2_SSH_LOCAL_PORT: ""
      WEBSSH2_SSH_TERM: xterm-256color
      WEBSSH2_SSH_READY_TIMEOUT: 20000
      WEBSSH2_SSH_KEEPALIVE_INTERVAL: 120000
      WEBSSH2_SSH_KEEPALIVE_COUNT_MAX: 10
      WEBSSH2_SSH_ALGORITHMS_PRESET: modern
      WEBSSH2_SSH_ALLOWED_SUBNETS: ""
      WEBSSH2_SSH_ALWAYS_SEND_KEYBOARD_INTERACTIVE: "false"
      WEBSSH2_SSH_DISABLE_INTERACTIVE_AUTH: "false"
      WEBSSH2_SSH_ENV_ALLOWLIST: ""
      # WEBSSH2_SSH_ALGORITHMS_CIPHER: "aes256-gcm@openssh.com,aes128-gcm@openssh.com"
      # WEBSSH2_SSH_ALGORITHMS_KEX: "ecdh-sha2-nistp256,ecdh-sha2-nistp384"
      # WEBSSH2_SSH_ALGORITHMS_HMAC: "hmac-sha2-256,hmac-sha2-512"
      # WEBSSH2_SSH_ALGORITHMS_COMPRESS: "none,zlib@openssh.com"
      # WEBSSH2_SSH_ALGORITHMS_SERVER_HOST_KEY: "ecdsa-sha2-nistp256,ssh-ed25519"

      # WebSSH2 Session Configuration
      WEBSSH2_SESSION_NAME: webssh2.sid
      WEBSSH2_SESSION_SECRET: "your-secret-key-change-in-production"

      # WebSSH2 Header Configuration
      WEBSSH2_HEADER_TEXT: "NGINX + WebSSH2 with FIPS"
      WEBSSH2_HEADER_BACKGROUND: blue

      # WebSSH2 User Defaults (optional)
      # WEBSSH2_USER_NAME: ""
      # WEBSSH2_USER_PASSWORD: ""
      # WEBSSH2_USER_PRIVATE_KEY: ""
      # WEBSSH2_USER_PASSPHRASE: ""

      # WebSSH2 Options
      WEBSSH2_OPTIONS_CHALLENGE_BUTTON: "true"
      WEBSSH2_OPTIONS_AUTO_LOG: "false"
      WEBSSH2_OPTIONS_ALLOW_REAUTH: "true"
      WEBSSH2_OPTIONS_ALLOW_RECONNECT: "true"
      WEBSSH2_OPTIONS_ALLOW_REPLAY: "true"
      WEBSSH2_OPTIONS_REPLAY_CRLF: "false"

      # WebSSH2 Logging
      WEBSSH2_LOGGING_FORMAT: json
      WEBSSH2_LOGGING_LEVEL: info
      WEBSSH2_LOGGING_STDOUT_ENABLED: "true"
      WEBSSH2_LOGGING_STDOUT_MIN_LEVEL: info
      WEBSSH2_LOGGING_SYSLOG_ENABLED: "false"
      WEBSSH2_LOGGING_SYSLOG_HOST: ""
      WEBSSH2_LOGGING_SYSLOG_PORT: 6514
      WEBSSH2_LOGGING_SYSLOG_APP_NAME: webssh2
      WEBSSH2_LOGGING_SYSLOG_ENTERPRISE_ID: 32473
      WEBSSH2_LOGGING_SYSLOG_TLS_ENABLED: "true"
      WEBSSH2_LOGGING_SYSLOG_TLS_CA_FILE: ""
      WEBSSH2_LOGGING_SYSLOG_TLS_CERT_FILE: ""
      WEBSSH2_LOGGING_SYSLOG_TLS_KEY_FILE: ""
      WEBSSH2_LOGGING_SYSLOG_TLS_REJECT_UNAUTHORIZED: "true"
      WEBSSH2_LOGGING_SYSLOG_BUFFER_SIZE: 1000
      WEBSSH2_LOGGING_SYSLOG_FLUSH_INTERVAL_MS: 1000
      WEBSSH2_LOGGING_SYSLOG_INCLUDE_JSON: "false"
      WEBSSH2_LOGGING_SAMPLING_DEFAULT_RATE: 1
      WEBSSH2_LOGGING_SAMPLING_RULES: ""
      WEBSSH2_LOGGING_RATE_LIMIT_RULES: ""

      # WebSSH2 CORS (allow localhost for development)
      WEBSSH2_HTTP_ORIGINS: "https://webssh2.localhost:443,https://localhost:443,https://127.0.0.1:443"
      
      # Health Check Configuration
      HEALTHCHECK_INTERVAL: 30
      HEALTHCHECK_TIMEOUT: 5
      HEALTHCHECK_RETRIES: 3
    
    # Volumes for persistent data (optional)
    # Uncomment volumes below as needed
    # volumes:
      # Mount custom certificates
      # - ./certs:/etc/nginx/certs:ro
      # - ./ca-certs:/etc/nginx/ca-certs:ro
      
      # Persist generated certificates
      # - nginx-webssh2-certs:/etc/nginx/certs
      
      # Persist logs
      # - nginx-webssh2-logs:/var/log
      
      # Configuration override
      # - ./config-override:/etc/nginx/conf.d/custom:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    
    # Health check
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Restart policy
    restart: unless-stopped
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (optional, for enhanced security)
    # read_only: true
    # tmpfs:
    #   - /tmp:noexec,nosuid,size=100m
    #   - /var/run:noexec,nosuid,size=100m
    #   - /var/cache/nginx:noexec,nosuid,size=100m
    
    # Network configuration
    networks:
      - webssh2-network

# Networks
networks:
  webssh2-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes (uncomment if using persistent storage)
# volumes:
#   nginx-webssh2-certs:
#     driver: local
#   nginx-webssh2-logs:
#     driver: local
